<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T40U3">CSH_ann</span>,<span class="var type1" id="S3T22U4">numUniqueResultsPerPixel</span>,<span class="var type1" id="S4T3U5">sortedErrors</span>] = TransitiveKNN_part2(<span class="var type1" id="S5T1U8">A</span>,<span class="var type1" id="S6T1U9">B</span>,<span class="var type1" id="S7T2U10">k</span>,<span class="var type1" id="S8T2U11">width</span>,<span class="var type1" id="S9T3U12">overSafeResults</span>,<span class="var type1" id="S10T3U13">errorMat</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2"> 2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3"> 3</a></span><span class="line"><span class="mxinfo" id="T2:U10">[<span class="var type1" id="S11T2U17">hA</span>,<span class="var type1" id="S12T2U18">wA</span>,<span class="var type1" id="S13T2U19">dA</span>] = size(<span class="var type1" id="S5T1U22">A</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4"> 4</a></span><span class="line"><span class="mxinfo" id="T2:U15">[<span class="var type1" id="S15T2U26">hB</span>,<span class="var type1" id="S16T2U27">wB</span>,<span class="var type1" id="S17T2U28">dB</span>] = size(<span class="var type1" id="S6T1U31">B</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5"> 5</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6"> 6</a></span><span class="line"><span class="comment">% sort by errors and then take the k mappings of the k smallest [unique!] errors</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7"> 7</a></span><span class="line"><span class="mxinfo" id="T2:U20"><span class="var type1" id="S18T2U34">br_boundary_to_ignore</span> = <span class="mxinfo" id="T2:U22"><span class="var type1" id="S8T2U36">width</span>-<span class="mxinfo" id="T2:U24">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8"> 8</a></span><span class="line"><span class="mxinfo" id="T22:U25"><span class="var type1" id="S3T22U40">numUniqueResultsPerPixel</span> = <span class="mxinfo" id="T22:U27">zeros(<span class="mxinfo" id="T2:U28"><span class="var type1" id="S11T2U44">hA</span>-<span class="var type1" id="S18T2U45">br_boundary_to_ignore</span></span>,<span class="mxinfo" id="T2:U31"><span class="var type1" id="S12T2U47">wA</span>-<span class="var type1" id="S18T2U48">br_boundary_to_ignore</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9"> 9</a></span><span class="line"><span class="mxinfo" id="T33:U34"><span class="var type1" id="S2T33U51">CSH_ann</span> = <span class="mxinfo" id="T33:U36">zeros(<span class="var type1" id="S7T2U54">k</span>,<span class="var type1" id="S11T2U55">hA</span>,<span class="var type1" id="S12T2U56">wA</span>,<span class="mxinfo" id="T2:U40">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10">10</a></span><span class="line"><span class="mxinfo" id="T3:U41"><span class="var type1" id="S4T3U60">sortedErrors</span> = <span class="mxinfo" id="T3:U43">zeros(<span class="var type1" id="S11T2U63">hA</span>,<span class="var type1" id="S12T2U64">wA</span>,<span class="var type1" id="S7T2U65">k</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11">11</a></span><span class="line"><span class="comment">% CSH_errors = zeros(hA,wA,k);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12">12</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S20T2U68">i</span> = <span class="mxinfo" id="T2:U48">1</span> : <span class="mxinfo" id="T2:U49"><span class="var type1" id="S11T2U72">hA</span>-<span class="var type1" id="S18T2U73">br_boundary_to_ignore</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13">13</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S21T2U76">j</span> = <span class="mxinfo" id="T2:U53">1</span> : <span class="mxinfo" id="T2:U54"><span class="var type1" id="S12T2U80">wA</span>-<span class="var type1" id="S18T2U81">br_boundary_to_ignore</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14">14</a></span><span class="line">        <span class="mxinfo" id="T11:U57">[<span class="var type1" id="S22T11U85">sErrors</span>,<span class="var type1" id="S23T11U86">sInds</span>] = sort(<span class="mxinfo" id="T11:U60">squeeze(<span class="mxinfo" id="T5:U61"><span class="var type1" id="S10T3U92">errorMat</span>(<span class="var type1" id="S20T2U93">i</span>,<span class="var type1" id="S21T2U94">j</span>,:)</span>)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15">15</a></span><span class="line">        <span class="mxinfo" id="T11:U65"><span class="var type1" id="S26T11U98">OSR</span> = <span class="mxinfo" id="T11:U67">squeeze(<span class="mxinfo" id="T5:U68"><span class="var type1" id="S9T3U102">overSafeResults</span>(<span class="var type1" id="S20T2U103">i</span>,<span class="var type1" id="S21T2U104">j</span>,:)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16">16</a></span><span class="line">        <span class="mxinfo" id="T11:U72"><span class="var type1" id="S27T11U108">sOSR</span> = <span class="mxinfo" id="T11:U74"><span class="var type1" id="S26T11U110">OSR</span>(<span class="var type1" id="S23T11U111">sInds</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17">17</a></span><span class="line">        <span class="mxinfo" id="T11:U77"><span class="var type1" id="S28T11U114">uOSRinds</span> = <span class="mxinfo" id="T11:U79">find(<span class="mxinfo" id="T23:U80"><span class="mxinfo" id="T22:U81">diff(<span class="var type1" id="S27T11U120">sOSR</span>)</span>~=<span class="mxinfo" id="T2:U83">0</span></span>)</span></span>; <span class="comment">% giving up (possibly) on the last index (diff gives a 1-shorter vector)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18">18</a></span><span class="line">        <span class="mxinfo" id="T2:U84"><span class="var type1" id="S31T2U124">kActual</span> = <span class="mxinfo" id="T2:U86">length(<span class="var type1" id="S28T11U127">uOSRinds</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19">19</a></span><span class="line">        <span class="mxinfo" id="T11:U88"><span class="var type1" id="S33T11U130">uOSRFinalinds</span> = <span class="mxinfo" id="T11:U90">zeros(<span class="var type1" id="S7T2U133">k</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20">20</a></span><span class="line">        <span class="mxinfo" id="T2:U92"><span class="mxinfo" id="T2:U93"><span class="var type1" id="S3T22U138">numUniqueResultsPerPixel</span>(<span class="var type1" id="S20T2U139">i</span>,<span class="var type1" id="S21T2U140">j</span>)</span> = <span class="mxinfo" id="T2:U97">min(<span class="var type1" id="S7T2U143">k</span>,<span class="var type1" id="S31T2U144">kActual</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21">21</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo" id="T9:U100"><span class="var type1" id="S31T2U148">kActual</span> &gt;= <span class="var type1" id="S7T2U149">k</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22">22</a></span><span class="line">            <span class="mxinfo" id="T11:U103"><span class="var type1" id="S33T11U152">uOSRFinalinds</span> = <span class="mxinfo" id="T11:U105"><span class="var type1" id="S28T11U154">uOSRinds</span>(<span class="mxinfo" id="T2:U107">1</span>:<span class="var type1" id="S7T2U157">k</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23">23</a></span><span class="line">        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24">24</a></span><span class="line">            <span class="mxinfo" id="T42:U109"><span class="mxinfo" id="T42:U110"><span class="var type1" id="S33T11U162">uOSRFinalinds</span>(<span class="mxinfo" id="T2:U112">1</span>:<span class="var type1" id="S31T2U165">kActual</span>)</span> = <span class="var type1" id="S28T11U166">uOSRinds</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25">25</a></span><span class="line">            <span class="mxinfo" id="T42:U115"><span class="mxinfo" id="T42:U116"><span class="var type1" id="S33T11U170">uOSRFinalinds</span>(<span class="mxinfo" id="T2:U118"><span class="var type1" id="S31T2U173">kActual</span>+<span class="mxinfo" id="T2:U120">1</span></span>:<span class="var type1" id="S7T2U175">k</span>)</span> = <span class="mxinfo" id="T2:U122"><span class="var type1" id="S28T11U177">uOSRinds</span>(<span class="mxinfo" id="T2:U124">end</span>)</span></span>; <span class="comment">% returning duplicate copies in this case</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26">26</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27">27</a></span><span class="line">        <span class="comment">% NN results:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28">28</a></span><span class="line">        <span class="mxinfo" id="T11:U125">[<span class="var type1" id="S2T33U184">CSH_ann</span>(:,<span class="var type1" id="S20T2U186">i</span>,<span class="var type1" id="S21T2U187">j</span>,2),<span class="var type1" id="S2T33U190">CSH_ann</span>(:,<span class="var type1" id="S20T2U192">i</span>,<span class="var type1" id="S21T2U193">j</span>,1)] = ind2sub(<span class="mxinfo" id="T17:U132">[<span class="var type1" id="S15T2U199">hB</span>,<span class="var type1" id="S16T2U200">wB</span>]</span>,<span class="mxinfo" id="T11:U135"><span class="var type1" id="S27T11U202">sOSR</span>(<span class="var type1" id="S33T11U203">uOSRFinalinds</span>)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29">29</a></span><span class="line">        <span class="comment">% sorted errors:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30">30</a></span><span class="line">        <span class="mxinfo" id="T5:U138"><span class="mxinfo" id="T5:U139"><span class="var type1" id="S4T3U207">sortedErrors</span>(<span class="var type1" id="S20T2U208">i</span>,<span class="var type1" id="S21T2U209">j</span>,:)</span> = <span class="mxinfo" id="T11:U143"><span class="var type1" id="S22T11U212">sErrors</span>(<span class="var type1" id="S33T11U213">uOSRFinalinds</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31">31</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32">32</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33">33</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34">34</a></span><span class="line"><span class="mxinfo" id="T40:U146"><span class="var type1" id="S2T40U216">CSH_ann</span> = <span class="mxinfo" id="T40:U148">permute(<span class="var type1" id="S2T33U219">CSH_ann</span>,[2,3,4,1])</span></span>;</span></span>
</pre>
